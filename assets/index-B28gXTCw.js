import{C as de,a as ue,b as ce}from"./cos-js-sdk-v5-Ci1OAid3.js";import{z as ee,A as D,C as J,d as K,x as R,D as te,E as j,F as le,a as L,G as U,H as oe,_ as ae,j as ne,I as pe,r as H,J as me,l as se,b as $,o as B,f as s,n as fe,w as d,e as f,K as he,h as T,t as O,L as ge,M as ve,B as S,k as ye,i as w,N as Q,m as X,p as Y,v as xe}from"./index-C5NNhcj1.js";import{N as we}from"./text-lCZzyaYh.js";import{N as be,h as _e,j as ke,k as Ce,l as ze}from"./supabaseAction-DTzG44gK.js";import{N as q}from"./Space-B1Q4eXpn.js";import{N as Fe}from"./Form-Dwv7jmx4.js";const Ve=ee("h",`
 font-size: var(--n-font-size);
 font-weight: var(--n-font-weight);
 margin: var(--n-margin);
 transition: color .3s var(--n-bezier);
 color: var(--n-text-color);
`,[D("&:first-child",{marginTop:0}),J("prefix-bar",{position:"relative",paddingLeft:"var(--n-prefix-width)"},[J("align-text",{paddingLeft:0},[D("&::before",{left:"calc(-1 * var(--n-prefix-width))"})]),D("&::before",`
 content: "";
 width: var(--n-bar-width);
 border-radius: calc(var(--n-bar-width) / 2);
 transition: background-color .3s var(--n-bezier);
 left: 0;
 top: 0;
 bottom: 0;
 position: absolute;
 `),D("&::before",{backgroundColor:"var(--n-bar-color)"})])]),Me=Object.assign(Object.assign({},j.props),{type:{type:String,default:"default"},prefix:String,alignText:Boolean}),Ne=m=>K({name:`H${m}`,props:Me,setup(p){const{mergedClsPrefixRef:h,inlineThemeDisabled:r}=te(p),u=j("Typography","-h",Ve,le,p,h),c=L(()=>{const{type:C}=p,{common:{cubicBezierEaseInOut:k},self:{headerFontWeight:N,headerTextColor:g,[U("headerPrefixWidth",m)]:x,[U("headerFontSize",m)]:F,[U("headerMargin",m)]:V,[U("headerBarWidth",m)]:P,[U("headerBarColor",C)]:a}}=u.value;return{"--n-bezier":k,"--n-font-size":F,"--n-margin":V,"--n-bar-color":a,"--n-bar-width":P,"--n-font-weight":N,"--n-text-color":g,"--n-prefix-width":x}}),o=r?oe(`h${m}`,L(()=>p.type[0]),c,p):void 0;return{mergedClsPrefix:h,cssVars:r?void 0:c,themeClass:o==null?void 0:o.themeClass,onRender:o==null?void 0:o.onRender}},render(){var p;const{prefix:h,alignText:r,mergedClsPrefix:u,cssVars:c,$slots:o}=this;return(p=this.onRender)===null||p===void 0||p.call(this),R(`h${m}`,{class:[`${u}-h`,`${u}-h${m}`,this.themeClass,{[`${u}-h--prefix-bar`]:h,[`${u}-h--align-text`]:r}],style:c},o)}}),$e=Ne("3"),Be=ee("p",`
 box-sizing: border-box;
 transition: color .3s var(--n-bezier);
 margin: var(--n-margin);
 font-size: var(--n-font-size);
 line-height: var(--n-line-height);
 color: var(--n-text-color);
`,[D("&:first-child","margin-top: 0;"),D("&:last-child","margin-bottom: 0;")]),He=Object.assign(Object.assign({},j.props),{depth:[String,Number]}),Se=K({name:"P",props:He,setup(m){const{mergedClsPrefixRef:p,inlineThemeDisabled:h}=te(m),r=j("Typography","-p",Be,le,m,p),u=L(()=>{const{depth:o}=m,C=o||"1",{common:{cubicBezierEaseInOut:k},self:{pFontSize:N,pLineHeight:g,pMargin:x,pTextColor:F,[`pTextColor${C}Depth`]:V}}=r.value;return{"--n-bezier":k,"--n-font-size":N,"--n-line-height":g,"--n-margin":x,"--n-text-color":o===void 0?F:V}}),c=h?oe("p",L(()=>`${m.depth||""}`),u,m):void 0;return{mergedClsPrefix:p,cssVars:h?void 0:u,themeClass:c==null?void 0:c.themeClass,onRender:c==null?void 0:c.onRender}},render(){var m;return(m=this.onRender)===null||m===void 0||m.call(this),R("p",{class:[`${this.mergedClsPrefix}-p`,this.themeClass],style:this.cssVars},this.$slots)}}),De={class:"file-uploader"},Re={style:{"margin-bottom":"12px"}},Te={key:0,class:"uploaded-files"},Le={class:"file-list"},Pe={class:"file-info"},Ie={key:0,xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24"},Ue={key:1,xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24"},Oe={class:"file-details"},je={class:"file-name"},Ae={class:"file-meta"},We={class:"file-actions"},qe={__name:"FileUploader",props:{modelValue:{type:String,default:""},prefix:{type:String,default:"documents/"},maxFiles:{type:Number,default:5},multiple:{type:Boolean,default:!0},maxSize:{type:Number,default:50}},emits:["update:modelValue","upload-success","upload-error","upload-progress","before-upload","file-remove","file-delete"],setup(m,{expose:p,emit:h}){const r={SecretId:"AKIDxmOnz042pSs5D8seMtFPM6cw3ygCeuxm",SecretKey:"iFgvxmPq9FAcu0xjJn7FBuSpzzoRr68z",Protocol:"https:",Bucket:"gensi-1316936694",Region:"ap-shanghai",ServiceDomain:"https://cos.ap-shanghai.myqcloud.com"},u=L(()=>({defaultFiles:"",maxSize:c.maxSize,maxFiles:c.maxFiles,multiple:c.multiple,accept:".pdf,.md,.markdown",listType:"text"})),c=m,o=h,C=new de(r),k=ne(),N=pe(),g=H([]),x=H([]),F=t=>`${r.Protocol||"https:"}//${r.Bucket}.cos.${r.Region}.myqcloud.com/${t}`,V=t=>{var l;switch((l=t.split(".").pop())==null?void 0:l.toLowerCase()){case"pdf":return"mdi:file-pdf-box";case"md":case"markdown":return"mdi:language-markdown";default:return"mdi:file-document"}},P=t=>{if(t===0)return"0 B";const e=1024,l=["B","KB","MB","GB"],n=Math.floor(Math.log(t)/Math.log(e));return parseFloat((t/Math.pow(e,n)).toFixed(2))+" "+l[n]},a=t=>!t||!t.trim()?[]:t.split(",").map(e=>{const l=e.trim();if(!l)return null;let n,y,v;if(l.startsWith("http://")||l.startsWith("https://"))try{n=new URL(l).pathname.substring(1),y=l,v=n.split("/").pop()||n}catch{return console.error("解析URL失败:",l),null}else n=l,y=F(l),v=l.split("/").pop()||l;return{key:n,name:v,url:y,size:0,uploadTime:"预设文件",isDefault:!0,icon:V(v)}}).filter(e=>e!==null),i=async({file:t,onProgress:e,onError:l,onFinish:n})=>{const y=`${c.prefix}${Date.now()}-${t.name}`;try{o("before-upload",{file:t,key:y});const v=await C.putObject({Bucket:r.Bucket,Region:r.Region,Key:y,Body:t.file,onProgress:I=>{const _=Math.round(I.percent*100);e({percent:_}),o("upload-progress",{file:t,percent:_,progressData:I})}}),z=F(y),M={key:y,name:t.name,url:z,size:t.file.size,uploadTime:new Date().toLocaleString(),cosResult:v,icon:V(t.name)};x.value.push(M),g.value.push({id:M.key,name:M.name,status:"finished",url:M.url,key:M.key,file:null,percentage:100}),k.success(`${t.name} 上传成功！`),n(),G(),o("upload-success",{file:t,fileInfo:M,result:v})}catch(v){console.error("上传失败:",v),k.error(`${t.name} 上传失败: ${v.message}`),l(),o("upload-error",{file:t,error:v})}},A=t=>{const{file:e}=t,l=e.name.toLowerCase(),n=l.endsWith(".pdf")||l.endsWith(".md")||l.endsWith(".markdown"),y=e.size<u.value.maxSize*1024*1024;return n?y?!0:(k.warning(`文件大小不能超过 ${u.value.maxSize}MB！`),!1):(k.warning("只能上传 PDF 或 Markdown 文件！"),!1)},b=async t=>{const{file:e,index:l}=t;if(console.log("准备删除文件:",e),e.url||e.key)return new Promise(n=>{N.warning({title:"确认删除",content:`确定要删除 ${e.name} 吗？`,positiveText:"确定",negativeText:"取消",onPositiveClick:async()=>{await re(e,n)},onNegativeClick:()=>{n(!1)}})});if(g.value&&g.value.length>l){const n=g.value[l];g.value.splice(l,1),o("file-remove",{file:n,index:l})}return!0},re=async(t,e)=>{try{let l=t.key;!l&&t.url&&(l=new URL(t.url).pathname.substring(1)),console.log("删除文件key:",l);const n=await C.deleteObject({Bucket:r.Bucket,Region:r.Region,Key:l});console.log("COS删除结果:",n);const y=x.value.findIndex(z=>z.key===l);y>-1&&(x.value.splice(y,1),console.log("从 uploadedFiles 中移除了索引:",y));const v=g.value.findIndex(z=>z.key===l);v>-1&&(g.value.splice(v,1),console.log("从 uploadFileList 中移除了索引:",v)),G(),o("file-delete"),k.success("删除成功！"),o("file-delete",{file:t}),e(!0)}catch(l){console.error("删除失败:",l),console.error("错误详情:",l),k.error(`删除失败: ${l.message}`),e(!1)}},W=(t=null)=>{const e=t||c.modelValue||u.value.defaultFiles;if(e){const l=a(e);x.value=[...l],g.value=l.map(n=>({id:n.key,name:n.name,status:"finished",url:n.url,key:n.key,file:null,percentage:100})),console.log("已加载文件:",l)}};me(()=>c.modelValue,(t,e)=>{t!==e&&(console.log("modelValue 变化:",t),W(t))},{immediate:!1});const E=()=>x.value.map(t=>t.url).join(","),G=()=>{const t=E();o("update:modelValue",t),console.log("更新 modelValue:",t)},Z=t=>{const e=document.createElement("a");e.href=t.url,e.download=t.name,e.target="_blank",document.body.appendChild(e),e.click(),document.body.removeChild(e)};return p({uploadedFiles:x,cos:C,getFilePathsString:E,initDefaultFiles:W,downloadFile:Z}),se(async()=>{console.log("FileUploader 组件已挂载"),W()}),(t,e)=>{const l=he,n=we,y=Se,v=ue,z=ce,M=$e,I=S;return B(),$("div",De,[s(z,{"file-list":g.value,"onUpdate:fileList":e[0]||(e[0]=_=>g.value=_),"custom-request":i,"before-upload":A,multiple:u.value.multiple,accept:u.value.accept,max:u.value.maxFiles,"list-type":u.value.listType,onRemove:b,class:"upload-area"},{default:d(()=>[s(v,null,{default:d(()=>[f("div",Re,[s(l,{size:"48",depth:3},{default:d(()=>e[1]||(e[1]=[f("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24"},[f("path",{fill:"currentColor",d:"M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"})],-1)])),_:1})]),s(n,{style:{"font-size":"16px"}},{default:d(()=>e[2]||(e[2]=[T(" 点击或者拖拽文件到该区域来上传 ")])),_:1}),s(y,{depth:"3",style:{margin:"8px 0 0 0"}},{default:d(()=>[T(" 支持 PDF、Markdown 文件，单个文件大小不超过 "+O(u.value.maxSize)+"MB ",1)]),_:1})]),_:1})]),_:1},8,["file-list","multiple","accept","max","list-type"]),x.value.length>0?(B(),$("div",Te,[s(M,null,{default:d(()=>e[3]||(e[3]=[T("已上传文件")])),_:1}),f("div",Le,[(B(!0),$(ge,null,ve(x.value,_=>(B(),$("div",{key:_.key,class:"file-item"},[f("div",Pe,[s(l,{size:"20",class:"file-icon"},{default:d(()=>[_.name.toLowerCase().endsWith(".pdf")?(B(),$("svg",Ie,e[4]||(e[4]=[f("path",{fill:"currentColor",d:"M8.267 14.68c-.184 0-.308.018-.372.036v1.178c.076.018.171.023.302.023.479 0 .774-.242.774-.651 0-.366-.254-.586-.704-.586zm3.487.012c-.2 0-.33.018-.407.036v2.61c.077.018.201.018.313.018.817.006 1.349-.444 1.349-1.396.006-.83-.479-1.268-1.255-1.268z"},null,-1),f("path",{fill:"currentColor",d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zM9.498 16.19c-.309.29-.765.42-1.296.42a2.23 2.23 0 0 1-.308-.018v1.426H7v-3.936A7.558 7.558 0 0 1 8.219 14c.557 0 .953.106 1.22.319.254.202.426.533.426.923-.001.392-.131.723-.367.948zm3.807 1.355c-.42.349-1.059.515-1.84.515-.468 0-.799-.03-1.024-.06v-3.917A7.947 7.947 0 0 1 11.66 14c.757 0 1.249.136 1.633.426.415.308.675.799.675 1.504 0 .763-.279 1.29-.663 1.615zM17 14.77h-1.532v.911H16.9v.734h-1.432v1.604h-.906V14.03H17v.74zM14 9h-1V4l5 5h-4z"},null,-1)]))):(B(),$("svg",Ue,e[5]||(e[5]=[f("path",{fill:"currentColor",d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zM6 20V4h7v5h5v11H6z"},null,-1)])))]),_:2},1024),f("div",Oe,[f("div",je,O(_.name),1),f("div",Ae,[f("span",null,O(P(_.size)),1),e[6]||(e[6]=f("span",{class:"separator"},"•",-1)),f("span",null,O(_.uploadTime),1)])])]),f("div",We,[s(I,{size:"small",type:"primary",quaternary:"",onClick:ie=>Z(_),title:"下载"},{icon:d(()=>[s(l,null,{default:d(()=>e[7]||(e[7]=[f("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24"},[f("path",{fill:"currentColor",d:"M5,20H19V18H5M19,9H15V3H9V9H5L12,16L19,9Z"})],-1)])),_:1})]),_:2},1032,["onClick"]),s(I,{size:"small",type:"error",quaternary:"",onClick:ie=>b({file:_,index:x.value.indexOf(_)}),title:"删除"},{icon:d(()=>[s(l,null,{default:d(()=>e[8]||(e[8]=[f("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24"},[f("path",{fill:"currentColor",d:"M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"})],-1)])),_:1})]),_:2},1032,["onClick"])])]))),128))])])):fe("",!0)])}}},Ke=ae(qe,[["__scopeId","data-v-1ebf15c4"]]),Ee={class:"p-4"},Ge={style:{width:"100%"}},Ze=K({__name:"index",setup(m){const p=ne(),h=H(!1),r=H(!1),u=H(!1),c=H(""),o=ye({title:"",filepath:""}),C=H([]),k=[{title:"ID",key:"id",width:80,ellipsis:{tooltip:!0}},{title:"推文标题",key:"title",ellipsis:{tooltip:!0}},{title:"附件",key:"filepath",width:200,render(a){if(!a.filepath)return"无附件";const i=a.filepath.split("/").pop()||"附件";return R("a",{href:a.filepath,target:"_blank",style:"color: #18a058; text-decoration: none;"},i)}},{title:"创建时间",key:"created_at",width:150,render(a){return a.created_at?new Date(a.created_at).toLocaleDateString("zh-CN"):"-"}},{title:"操作",key:"actions",width:150,render(a){return R(q,null,{default:()=>[R(S,{size:"small",type:"primary",onClick:()=>F(a)},{default:()=>"编辑"}),R(S,{size:"small",type:"error",onClick:()=>P(a.id)},{default:()=>"删除"})]})}}],N=L(()=>c.value?C.value.filter(a=>a.title.includes(c.value)):C.value);async function g(){h.value=!0;try{const a=await _e();C.value=a||[]}catch(a){console.error("加载公众推文数据失败:",a),p.error("加载数据失败")}finally{h.value=!1}}function x(){console.log("handleAdd called"),console.log("showModal before:",r.value),u.value=!1,Object.assign(o,{title:"",filepath:""}),r.value=!0,console.log("showModal after:",r.value)}function F(a){u.value=!0,Object.assign(o,a),r.value=!0}async function V(){if(!o.title){p.error("请填写推文标题");return}h.value=!0;try{const a={title:o.title,filepath:o.filepath||""};u.value&&o.id?(await ke(o.id,a),p.success("更新成功")):(await Ce(a),p.success("新增成功")),r.value=!1,await g()}catch(a){console.error("保存公众推文失败:",a),p.error("保存失败")}finally{h.value=!1}}async function P(a){h.value=!0;try{await ze(a),p.success("删除成功"),await g()}catch(i){console.error("删除公众推文失败:",i),p.error("删除失败")}finally{h.value=!1}}return se(()=>{g()}),(a,i)=>{const A=Ke;return B(),$("div",Ee,[s(w(X),{title:"公众推文管理",bordered:!1},{"header-extra":d(()=>[s(w(q),null,{default:d(()=>[s(w(Q),{value:c.value,"onUpdate:value":i[0]||(i[0]=b=>c.value=b),placeholder:"搜索推文标题",clearable:"",style:{width:"200px"}},null,8,["value"]),s(w(S),{type:"primary",onClick:x},{default:d(()=>i[5]||(i[5]=[T(" 新增推文 ")])),_:1})]),_:1})]),default:d(()=>[s(w(be),{loading:h.value,columns:k,data:N.value,pagination:{pageSize:10},"row-key":b=>b.id},null,8,["loading","data","row-key"])]),_:1}),s(w(xe),{show:r.value,"onUpdate:show":i[4]||(i[4]=b=>r.value=b),style:{width:"600px"},"mask-closable":!1,closable:!0,title:"推文管理"},{default:d(()=>[s(w(X),{title:u.value?"编辑推文":"新增推文",size:"small"},{action:d(()=>[s(w(q),null,{default:d(()=>[s(w(S),{onClick:i[3]||(i[3]=b=>r.value=!1)},{default:d(()=>i[7]||(i[7]=[T("取消")])),_:1}),s(w(S),{type:"primary",onClick:V,loading:h.value},{default:d(()=>i[8]||(i[8]=[T("确定")])),_:1},8,["loading"])]),_:1})]),default:d(()=>[s(w(Fe),{model:o,"label-placement":"left","label-width":"80px","require-mark-placement":"right-hanging"},{default:d(()=>[s(w(Y),{label:"推文标题",path:"title",required:""},{default:d(()=>[s(w(Q),{value:o.title,"onUpdate:value":i[1]||(i[1]=b=>o.title=b),placeholder:"请输入推文标题"},null,8,["value"])]),_:1}),s(w(Y),{label:"附件文件",path:"filepath"},{default:d(()=>[f("div",Ge,[s(A,{modelValue:o.filepath,"onUpdate:modelValue":i[2]||(i[2]=b=>o.filepath=b),prefix:"group/","max-files":1,multiple:!1,style:{width:"100%"}},null,8,["modelValue"]),i[6]||(i[6]=f("div",{style:{"margin-top":"8px","font-size":"12px",color:"#666"}}," 支持上传 PDF、Markdown 文件，只能上传一个文件 ",-1))])]),_:1})]),_:1},8,["model"])]),_:1},8,["title"])]),_:1},8,["show"])])}}}),lt=ae(Ze,[["__scopeId","data-v-d7cec041"]]);export{lt as default};
