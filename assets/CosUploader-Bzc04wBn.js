import{C as V,b as P}from"./cos-js-sdk-v5-Ci1OAid3.js";import{j as _,I as D,r as R,J as L,l as j,b as M,o as O,f as T}from"./index-C5NNhcj1.js";const K={class:"cos-uploader"},W={__name:"CosUploader",props:{modelValue:{type:String,default:[]},prefix:{type:String,default:"uploads/"}},emits:["update:modelValue","upload-success","upload-error","upload-progress","before-upload","file-remove","image-delete"],setup(S,{expose:$,emit:w}){const r={SecretId:"AKIDxmOnz042pSs5D8seMtFPM6cw3ygCeuxm",SecretKey:"iFgvxmPq9FAcu0xjJn7FBuSpzzoRr68z",Protocol:"https:",Bucket:"gensi-1316936694",Region:"ap-shanghai",ServiceDomain:"https://cos.ap-shanghai.myqcloud.com"},u={defaultFiles:"",maxSize:10,maxFiles:1,multiple:!0,accept:"image/*",listType:"image-card"},g=S,i=w,f=new V(r),p=_(),b=D(),n=R([]),m=R([]),h=e=>`${r.Protocol||"https:"}//${r.Bucket}.cos.${r.Region}.myqcloud.com/${e}`,z=e=>!e||!e.trim()?[]:e.split(",").map(o=>{const t=o.trim();if(!t)return null;let l,s,a;if(t.startsWith("http://")||t.startsWith("https://"))try{l=new URL(t).pathname.substring(1),s=t,a=l.split("/").pop()||l}catch{return console.error("解析URL失败:",t),null}else l=t,s=h(t),a=t.split("/").pop()||t;return{key:l,name:a,url:s,size:0,uploadTime:"预设文件",isDefault:!0}}).filter(o=>o!==null),U=async({file:e,onProgress:o,onError:t,onFinish:l})=>{const s=`${g.prefix}${Date.now()}-${e.name}`;try{i("before-upload",{file:e,key:s});const a=await f.putObject({Bucket:r.Bucket,Region:r.Region,Key:s,Body:e.file,onProgress:x=>{const F=Math.round(x.percent*100);o({percent:F}),i("upload-progress",{file:e,percent:F,progressData:x})}}),c=h(s),d={key:s,name:e.name,url:c,size:e.file.size,uploadTime:new Date().toLocaleString(),cosResult:a};m.value.push(d),n.value.push({id:d.key,name:d.name,status:"finished",url:d.url,key:d.key,file:null,percentage:100}),p.success(`${e.name} 上传成功！`),l(),k(),i("upload-success",{file:e,imageInfo:d,result:a})}catch(a){console.error("上传失败:",a),p.error(`${e.name} 上传失败: ${a.message}`),t(),i("upload-error",{file:e,error:a})}},B=e=>{var s;const{file:o}=e,t=(s=o.type)==null?void 0:s.startsWith("image/"),l=o.size<u.maxSize*1024*1024;return t?l?!0:(p.warning(`图片大小不能超过 ${u.maxSize}MB！`),!1):(p.warning("只能上传图片文件！"),!1)},C=async e=>{const{file:o,index:t}=e;if(console.log("准备删除文件:",o),o.url||o.key)return new Promise(l=>{b.warning({title:"确认删除",content:`确定要删除 ${o.name} 吗？`,positiveText:"确定",negativeText:"取消",onPositiveClick:async()=>{await I(o,l)},onNegativeClick:()=>{l(!1)}})});if(n.value&&n.value.length>t){const l=n.value[t];n.value.splice(t,1),i("file-remove",{file:l,index:t})}return!0},I=async(e,o)=>{try{let t=e.key;!t&&e.url&&(t=new URL(e.url).pathname.substring(1)),console.log("删除文件key:",t);const l=await f.deleteObject({Bucket:r.Bucket,Region:r.Region,Key:t});console.log("COS删除结果:",l);const s=m.value.findIndex(c=>c.key===t);s>-1&&(m.value.splice(s,1),console.log("从 uploadedImages 中移除了索引:",s));const a=n.value.findIndex(c=>c.key===t);a>-1&&(n.value.splice(a,1),console.log("从 uploadFileList 中移除了索引:",a)),k(),i("image-delete"),p.success("删除成功！"),i("image-delete",{image:e}),o(!0)}catch(t){console.error("删除失败:",t),console.error("错误详情:",t),p.error(`删除失败: ${t.message}`),o(!1)}},y=(e=null)=>{const o=e||g.modelValue||u.defaultFiles;if(o){const t=z(o);m.value=[...t],n.value=t.map(l=>({id:l.key,name:l.name,status:"finished",url:l.url,key:l.key,file:null,percentage:100})),console.log("已加载文件:",t)}};L(()=>g.modelValue,(e,o)=>{e!==o&&(console.log("modelValue 变化:",e),y(e))},{immediate:!1});const v=()=>m.value.map(e=>e.url).join(","),k=()=>{const e=v();i("update:modelValue",e),console.log("更新 modelValue:",e)};return $({uploadedImages:m,cos:f,getFilePathsString:v,initDefaultFiles:y}),j(async()=>{console.log("CosUploader 组件已挂载"),y()}),(e,o)=>{const t=P;return O(),M("div",K,[T(t,{"file-list":n.value,"onUpdate:fileList":o[0]||(o[0]=l=>n.value=l),"custom-request":U,"before-upload":B,multiple:u.multiple,accept:u.accept,max:u.maxFiles,"list-type":u.listType,onRemove:C},null,8,["file-list","multiple","accept","max","list-type"])])}}};export{W as _};
